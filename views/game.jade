extends layout

block content
  div.scene
      div.score.top
      div.score.bottom

block script
  script(type='text/javascript').
    var socket = io.connect('http://127.0.0.1:3030');
    var context;
    var startState;

    socket.on('tick', function (state) {
        renderScene(state);
    });

    socket.on('start', function (state) {
        var canvas = document.createElement("canvas");
        startState = state;

        canvas.width = startState.width;
        canvas.height = startState.height;

        document.getElementsByClassName('scene')[0].appendChild(canvas);

        context = canvas.getContext('2d');

        renderScene(state);

        registerControl();
    });

    function renderScene (state) {
        document.getElementsByClassName('score top')[0].textContent = state.player1.score;
        document.getElementsByClassName('score bottom')[0].textContent = state.player2.score;

        context.fillStyle = "#000000";
        context.fillRect(0, 0, startState.width, startState.height);

        context.fillStyle = "#FFFFFF";
        context.fillRect(
            state.player1.x,
            state.player1.y,
            startState.player1.width,
            startState.player1.height
        );

        context.fillStyle = "#FFFFFF";
        context.fillRect(
            state.player2.x,
            state.player2.y,
            startState.player2.width,
            startState.player2.height
        );

        context.beginPath();
        context.arc(state.ball.x, state.ball.y, 5, 2 * Math.PI, false);
        context.fillStyle = "#FFFFFF";
        context.fill();
    }

    function registerControl() {
        window.addEventListener("keydown", function (event) {
            if (event.keyCode == 37) {
                socket.emit('left.start', socket.id);
            }
            if (event.keyCode == 39) {
                socket.emit('right.start', socket.id);
            }
        });

        window.addEventListener("keyup", function (event) {
            if (event.keyCode == 37) {
                socket.emit('left.end', socket.id);
            }
            if (event.keyCode == 39) {
                socket.emit('right.end', socket.id);
            }
        });
    }